<div class="card">
  <header class="card-header">
    <h2 class="section-title">Ordens de Serviço</h2>
    <div class="actions">
      <div class="filters">
        <input type="search" placeholder="Buscar por cliente, veículo ou código" [(ngModel)]="searchTerm" (ngModelChange)="loadOrders()" />
        <select [(ngModel)]="statusFilter" (change)="loadOrders()">
          <option *ngFor="let option of statusOptions" [value]="option.value">{{ option.label }}</option>
        </select>
      </div>
      <button class="button" (click)="toggleCreate()" *ngIf="isAdmin()">
        {{ showCreateForm ? 'Cancelar' : 'Nova OS' }}
      </button>
    </div>
  </header>

  <p *ngIf="listError" class="error">{{ listError }}</p>
  <p *ngIf="loading">Carregando ordens de serviço...</p>

  <table class="table" *ngIf="!loading && orders.length">
    <thead>
      <tr>
        <th>Código</th>
        <th>Cliente</th>
        <th>Veículo</th>
        <th>Status</th>
        <th>Total</th>
        <th>Atualização</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let order of orders">
        <td><a [routerLink]="['/ordens-servico', order.id]">{{ order.code }}</a></td>
        <td>{{ order.clientName }}</td>
        <td>{{ order.vehicle }}</td>
        <td><span class="badge {{ statusClass(order.status) }}">{{ formatStatus(order.status) }}</span></td>
        <td>{{ order.totalCost | currency:'BRL':'symbol-narrow':'1.2-2' }}</td>
        <td>{{ order.updatedAt | date:'short' }}</td>
        <td>
          <div class="status-actions" *ngIf="isAdmin(); else mechanicView">
            <select [ngModel]="order.status" (ngModelChange)="updateStatus(order, $event)">
              <option *ngFor="let option of statusOptions" [value]="option.value" [disabled]="option.value === 'todos'">
                {{ option.label }}
              </option>
            </select>
          </div>
          <ng-template #mechanicView>
            <a class="button secondary" [routerLink]="['/ordens-servico', order.id]">Abrir</a>
          </ng-template>
        </td>
      </tr>
    </tbody>
  </table>
  <p *ngIf="!loading && !orders.length" class="empty">Nenhuma ordem localizada com os filtros aplicados.</p>
</div>

<div class="card" *ngIf="showCreateForm">
  <h3>Cadastrar nova OS</h3>
  <p class="error" *ngIf="createError">{{ createError }}</p>
  <form (ngSubmit)="submitOrder()">
    <div class="form-grid columns-2">
      <label>
        Cliente
        <select [(ngModel)]="newOrder.clientId" name="clientId">
          <option [ngValue]="0" disabled>Selecione...</option>
          <option *ngFor="let client of clients" [ngValue]="client.id">{{ client.name }}</option>
        </select>
      </label>
      <label>
        Veículo
        <input type="text" [(ngModel)]="newOrder.vehicle" name="vehicle" placeholder="Modelo / Placa" />
      </label>
      <label>
        Status inicial
        <select [(ngModel)]="newOrder.status" name="status">
          <option *ngFor="let option of statusOptions" [value]="option.value" [disabled]="option.value === 'todos'">
            {{ option.label }}
          </option>
        </select>
      </label>
      <label>
        Data agendada
        <input type="date" [(ngModel)]="newOrder.scheduledDate" name="scheduledDate" />
      </label>
    </div>

    <label>
      Descrição dos serviços
      <textarea rows="3" [(ngModel)]="newOrder.description" name="description" placeholder="Detalhes do problema, sintomas e aprovação..."></textarea>
    </label>

    <label>
      Anotações do mecânico
      <textarea rows="3" [(ngModel)]="newOrder.mechanicNotes" name="mechanicNotes" placeholder="Observações internas"></textarea>
    </label>

    <section class="items-section">
      <header>
        <h4>Mão de obra</h4>
        <button type="button" class="button secondary" (click)="addLaborItem()">Adicionar</button>
      </header>
      <div class="items-grid">
        <div class="item" *ngFor="let labor of laborItems; let i = index">
          <input type="text" [(ngModel)]="labor.description" name="labor-desc-{{ i }}" placeholder="Descrição" />
          <div class="row">
            <input type="number" min="0" step="0.5" [(ngModel)]="labor.hours" name="labor-hours-{{ i }}" placeholder="Horas" />
            <input type="number" min="0" step="0.01" [(ngModel)]="labor.rate" name="labor-rate-{{ i }}" placeholder="Valor hora" />
          </div>
          <button type="button" class="remove" (click)="removeLaborItem(i)">Remover</button>
        </div>
      </div>
    </section>

    <section class="items-section">
      <header>
        <h4>Peças</h4>
        <button type="button" class="button secondary" (click)="addPartItem()">Adicionar</button>
      </header>
      <div class="items-grid">
        <div class="item" *ngFor="let part of partItems; let i = index">
          <input type="text" [(ngModel)]="part.description" name="part-desc-{{ i }}" placeholder="Descrição" />
          <div class="row">
            <input type="number" min="1" step="1" [(ngModel)]="part.quantity" name="part-qty-{{ i }}" placeholder="Qtd" />
            <input type="number" min="0" step="0.01" [(ngModel)]="part.unitPrice" name="part-price-{{ i }}" placeholder="Valor unitário" />
          </div>
          <button type="button" class="remove" (click)="removePartItem(i)">Remover</button>
        </div>
      </div>
    </section>

    <div class="button-bar">
      <button type="submit" class="button" [disabled]="creating">
        {{ creating ? 'Salvando...' : 'Registrar OS' }}
      </button>
    </div>
  </form>
</div>
